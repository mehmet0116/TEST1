name: DeepSeek V3.2 GRANDMASTER (FULL AGENT)
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  grandmaster_agent:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Proje SahasÄ±nÄ± Tarama
        uses: actions/checkout@v4

      - name: DeepSeek Grandmaster Motorunu Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            /**
             * â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
             * â•‘      DEEPSEEK V3.2 SPECIALE: GRANDMASTER EDITION (v9.0)       â•‘
             * â•‘      Teknoloji: Reasoning-First & Autonomous Agentic Vision   â•‘
             * â•‘      Kaynak: DeepSeek Technical Report (Paper)                â•‘
             * â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
             */
            
            console.log("ğŸš€ [GRANDMASTER] Tam donanÄ±mlÄ± ajan baÅŸlatÄ±lÄ±yor...");
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("Kritik Hata: API AnahtarÄ± bulunamadÄ±!");

            // --- 1. GELÄ°ÅMÄ°Å GÃ–RÃœÅ (ADVANCED VISION & CONTEXT) ---
            // Ajan, sadece komutu deÄŸil, projenin "ruhunu" (yapÄ±landÄ±rma dosyalarÄ±nÄ±) okumalÄ±dÄ±r.
            // Bu liste, projenin dilini ve baÄŸÄ±mlÄ±lÄ±klarÄ±nÄ± anlamasÄ±nÄ± saÄŸlar.
            const criticalFiles = [
              'package.json', 'package-lock.json', // Node.js
              'requirements.txt', 'pyproject.toml', 'Pipfile', // Python
              'composer.json', // PHP
              'go.mod', // Go
              'Cargo.toml', // Rust
              'pom.xml', 'build.gradle', // Java
              'README.md', 'Dockerfile', 'docker-compose.yml', '.gitignore' // Genel
            ];
            
            // KullanÄ±cÄ±nÄ±n mesajÄ±nda geÃ§en Ã¶zel dosyalarÄ± yakala
            const fileMentionRegex = /\b[\w-\/]+\.(js|py|html|css|json|md|yml|yaml|txt|java|c|cpp|go|rs|php|sql|ts|tsx|sh)\b/g;
            const mentionedFiles = [...new Set(userMessage.match(fileMentionRegex) || [])];
            
            // Okunacak tÃ¼m dosyalarÄ± birleÅŸtir (Kritik + Bahsedilenler)
            const filesToRead = [...new Set([...criticalFiles, ...mentionedFiles])];
            
            let currentContext = "";
            console.log(`ğŸ‘€ [GÃ–Z] ${filesToRead.length} potansiyel dosya taranÄ±yor...`);

            for (const file of filesToRead) {
              try {
                const { data: fileData } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: file
                });
                
                // Sadece metin dosyalarÄ±nÄ± oku, binary dosyalarÄ± atla
                if (fileData.encoding === 'base64' && fileData.type === 'file') {
                  const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
                  // Token limitini korumak iÃ§in Ã§ok bÃ¼yÃ¼k dosyalarÄ±n sadece baÅŸÄ±nÄ± ve sonunu al
                  let safeContent = content;
                  if (content.length > 10000) {
                     safeContent = content.substring(0, 5000) + "\n...[ARA KESÄ°LDÄ°]...\n" + content.substring(content.length - 2000);
                  }
                  currentContext += `\n>>> DOSYA BAÅLANGICI: ${file} <<<\n${safeContent}\n>>> DOSYA SONU <<<\n`;
                  console.log(`ğŸ“– Okundu ve HafÄ±zaya AlÄ±ndÄ±: ${file}`);
                }
              } catch (e) {
                // Dosya yoksa sorun deÄŸil, bu normal
              }
            }

            // --- 2. GRANDMASTER PROMPT (RAPORDAN ALINAN TEKNÄ°KLER) ---
            [cite_start]// Raporun "Thinking in Tool-Use" [cite: 279] bÃ¶lÃ¼mÃ¼ndeki strateji.
            const systemPrompt = `
            Sen DeepSeek V3.2 Speciale (Grandmaster Level) modelisin.
            Sen sÄ±radan bir kodlayÄ±cÄ± deÄŸil, Otonom bir Ajan (Autonomous Agent)'sÄ±n.
            
            GÃ–REVÄ°N:
            KullanÄ±cÄ±nÄ±n isteÄŸini, mevcut proje yapÄ±sÄ±nÄ± (CONTEXT) analiz ederek en profesyonel ÅŸekilde yerine getirmek.
            
            SPECIALE KURALLARI:
            1. **DÃ¼ÅŸÃ¼nce Zinciri (CoT):** Kod yazmadan Ã¶nce <think> bloÄŸunda detaylÄ± plan yap. HatalarÄ± Ã¶nceden Ã¶ngÃ¶r.
            2. **Ajan YeteneÄŸi:** Dosya oluÅŸtururken, diÄŸer dosyalarla (Ã¶rn. package.json) uyumlu olduÄŸundan emin ol.
            3. **Tam Hakimiyet:** "Production Ready" (CanlÄ±ya HazÄ±r) kod yaz. Eksik import, yarÄ±m fonksiyon bÄ±rakma.
            
            Ã‡IKTI FORMATI (KESÄ°N VE DEÄÄ°ÅMEZ):
            Dosya oluÅŸturmak/gÃ¼ncellemek iÃ§in:
            ---FILENAME: yol/dosya_adi.uzantÄ±---
            [Kodun TamamÄ±]
            ---END_OF_FILE---
            
            Dosya silmek iÃ§in:
            ---DELETE: yol/dosya_adi.uzantÄ±---
            ---END_DELETE---
            `.trim();

            console.log("ğŸ§  [BEYÄ°N] Reasoning (Derin DÃ¼ÅŸÃ¼nme) modu aktif...");

            // --- 3. API Ã‡AÄRISI (DEEPSEEK REASONER) ---
            // En gÃ¼Ã§lÃ¼ model olan 'deepseek-reasoner' kullanÄ±lÄ±yor.
            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                  method: "POST",
                  headers: {
                    "Authorization": `Bearer ${apiKey}`, 
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    model: "deepseek-reasoner", // Speciale Modeli
                    messages: [
                      { role: "system", content: systemPrompt },
                      { 
                        role: "user", 
                        content: `GÃ–REV: ${userMessage}\n\n=== MEVCUT PROJE DURUMU (CONTEXT) ===\n${currentContext}` 
                      }
                    ],
                    stream: false,
                    max_tokens: 8000 // Maksimum dÃ¼ÅŸÃ¼nme kapasitesi
                  })
                });

                if (!response.ok) {
                   const errText = await response.text();
                   throw new Error(`API HatasÄ±: ${errText}`);
                }

                const data = await response.json();
                
                // DeepSeek V3.2 Cevap YapÄ±sÄ±
                const aiReply = data.choices[0].message.content; 
                const reasoning = data.choices[0].message.reasoning_content; // DÃ¼ÅŸÃ¼nce zinciri
                
                console.log(`âš¡ Grandmaster CevabÄ± Geldi. Kod: ${aiReply ? aiReply.length : 0} karakter, DÃ¼ÅŸÃ¼nce: ${reasoning ? reasoning.length : 0} karakter.`);

                // --- 4. DOSYA Ä°ÅLEME MOTORU (EXECUTION ENGINE) ---
                const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
                const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
                
                let match;
                let filesUpdated = [];
                let filesDeleted = [];
                let actionLog = "";

                // Dosya OluÅŸturma DÃ¶ngÃ¼sÃ¼
                if (aiReply) {
                    while ((match = fileRE.exec(aiReply)) !== null) {
                      const fname = match[1].trim();
                      const fcont = match[2].trim();
                      try {
                        let sha;
                        try {
                          const { data: existing } = await github.rest.repos.getContent({
                            owner: context.repo.owner, repo: context.repo.repo, path: fname
                          });
                          sha = existing.sha;
                        } catch (e) {}

                        await github.rest.repos.createOrUpdateFileContents({
                          owner: context.repo.owner, repo: context.repo.repo, path: fname,
                          message: `DeepSeek Grandmaster: ${fname}`,
                          content: Buffer.from(fcont).toString('base64'),
                          sha: sha
                        });
                        filesUpdated.push(fname);
                        console.log(`âœ… Dosya YazÄ±ldÄ±: ${fname}`);
                      } catch (err) { 
                        console.error(`âŒ Hata (${fname}): ${err.message}`);
                        actionLog += `\nâŒ Hata (${fname}): ${err.message}`;
                      }
                    }

                    // Dosya Silme DÃ¶ngÃ¼sÃ¼
                    while ((match = delRE.exec(aiReply)) !== null) {
                      const fname = match[1].trim();
                      // Kendini ve workflow'u silmesini engelle (GÃ¼venlik)
                      if (['.github/workflows/deepseek.yml'].includes(fname)) continue;
                      
                      try {
                        const { data: existing } = await github.rest.repos.getContent({
                          owner: context.repo.owner, repo: context.repo.repo, path: fname
                        });
                        await github.rest.repos.deleteFile({
                          owner: context.repo.owner, repo: context.repo.repo, path: fname,
                          message: `DeepSeek Grandmaster: ${fname} silindi`,
                          sha: existing.sha
                        });
                        filesDeleted.push(fname);
                         console.log(`ğŸ—‘ï¸ Dosya Silindi: ${fname}`);
                      } catch (e) {}
                    }
                }

                // --- 5. DETAYLI RAPORLAMA ---
                let report = `### ğŸ‘‘ DeepSeek V3.2 Grandmaster Raporu\n\n`;
                
                // DÃ¼ÅŸÃ¼nce Zincirini GÃ¶ster (Rapordaki gibi Reasoning Trace)
                if (reasoning) {
                    // DÃ¼ÅŸÃ¼nce Ã§ok uzunsa yorumu patlatmamak iÃ§in kÄ±salt, ama linkle veya Ã¶zetle
                    const displayReasoning = reasoning.length > 5000 ? reasoning.substring(0, 5000) + "\n... (DÃ¼ÅŸÃ¼nce Ã§ok derin, devamÄ± gizlendi)" : reasoning;
                    report += `<details><summary>ğŸ§  <b>Modelin DÃ¼ÅŸÃ¼nce SÃ¼reci (Reasoning Trace)</b> - TÄ±kla GÃ¶r</summary>\n\n\`\`\`text\n${displayReasoning}\n\`\`\`\n</details>\n\n`;
                }

                if (filesUpdated.length > 0) {
                   report += `#### ğŸ› ï¸ Uygulanan DeÄŸiÅŸiklikler:\n`;
                   filesUpdated.forEach(f => report += `- âœ… **OluÅŸturuldu/GÃ¼ncellendi:** \`${f}\`\n`);
                }
                
                if (filesDeleted.length > 0) {
                   report += `#### ğŸ—‘ï¸ Temizlik Ä°ÅŸlemleri:\n`;
                   filesDeleted.forEach(f => report += `- âŒ **Silindi:** \`${f}\`\n`);
                }
                
                if (filesUpdated.length === 0 && filesDeleted.length === 0) {
                   report += `#### ğŸ’¬ Ajan MesajÄ±:\n${aiReply}\n`;
                }

                if (actionLog) {
                    report += `\n**âš ï¸ Sistem NotlarÄ±:**\n${actionLog}`;
                }

                await github.rest.issues.createComment({
                  owner: context.repo.owner, repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });

            } catch (error) {
                console.error("GENEL HATA:", error);
                await github.rest.issues.createComment({
                  owner: context.repo.owner, repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: `### ğŸ’¥ Kritik Sistem HatasÄ±\n\n**Hata DetayÄ±:** ${error.message}\n\nLÃ¼tfen API kotanÄ±zÄ± veya GitHub Secrets ayarÄ±nÄ± kontrol edin.`
                });
            }
