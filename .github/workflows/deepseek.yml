name: DeepSeek V3.2 SPECIALE (ULTIMATE POWER)
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  speciale_ultimate:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Depoyu Kontrol Et
        uses: actions/checkout@v4

      - name: DeepSeek Speciale Motorunu √áalƒ±≈ütƒ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            console.log("üöÄ [SPECIALE v8.0] GPT-5 Katili Devreye Giriyor...");
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("API Anahtarƒ± eksik!");

            // --- CONTEXT (BAƒûLAM) ---
            const fileMentionRegex = /\b[\w-]+\.(js|py|html|css|json|md|yml|txt|java|c|cpp|go|rs|php)\b/g;
            const mentionedFiles = [...new Set(userMessage.match(fileMentionRegex) || [])];
            let currentContext = "";

            if (mentionedFiles.length > 0) {
              for (const file of mentionedFiles) {
                try {
                  const { data: fileData } = await github.rest.repos.getContent({
                    owner: context.repo.owner, repo: context.repo.repo, path: file
                  });
                  if (fileData.encoding === 'base64') {
                    const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
                    currentContext += `\n>>> DOSYA: ${file} <<<\n${content.substring(0, 6000)}\n---SON---\n`;
                  }
                } catch (e) {}
              }
            }

            // --- PROMPT (KESƒ∞N EMƒ∞R) ---
            const systemPrompt = `
            Sen DeepSeek-V3.2-Speciale modelisin. Matematik ve Kodlamada d√ºnyada 1 numarasƒ±n.
            
            √ñNEMLƒ∞ KURAL: 
            Sen "Reasoning" (D√º≈ü√ºnme) yaparsƒ±n. <think> bloƒüunda istediƒüin kadar d√º≈ü√ºn.
            AMA Fƒ∞NAL CEVABINDA MUTLAKA KOD DOSYALARINI OLU≈ûTURMALISIN.
            D√º≈ü√ºnceye dalƒ±p kodu yazmayƒ± unutma!
            
            √áIKTI FORMATI (Bunu kullanmazsan sistem √ßalƒ±≈ümaz):
            ---FILENAME: dosya_adi.uzantƒ±---
            [Kodun Tamamƒ±]
            ---END_OF_FILE---
            
            Silme i≈ülemi:
            ---DELETE: dosya_adi.uzantƒ±---
            ---END_DELETE---
            `.trim();

            console.log("üß† [Reasoning] Derin d√º≈ü√ºnce s√ºreci ba≈üladƒ±...");

            // --- API: DEEPSEEK-REASONER (EN G√ú√áL√ú MODEL) ---
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-reasoner", // ƒ∞≈ûTE BU! Speciale g√ºc√º.
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: `G√ñREV: ${userMessage}\n\nBAƒûLAM:\n${currentContext}` }
                ],
                stream: false,
                max_tokens: 8000 // Uzun d√º≈ü√ºnmesi i√ßin yer a√ßtƒ±k
              })
            });

            if (!response.ok) {
               const errText = await response.text();
               throw new Error(`API Hatasƒ±: ${errText}`);
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;      // Kodun olduƒüu kƒ±sƒ±m
            const reasoning = data.choices[0].message.reasoning_content; // D√º≈ü√ºnce kƒ±smƒ±

            console.log(`‚ö° Cevap alƒ±ndƒ±. Kod uzunluƒüu: ${aiReply ? aiReply.length : 0}`);

            // --- DOSYA ƒ∞≈ûLEME ---
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            
            let match;
            let filesUpdated = [];
            let filesDeleted = [];

            if (aiReply) {
                while ((match = fileRE.exec(aiReply)) !== null) {
                  const fname = match[1].trim();
                  const fcont = match[2].trim();
                  try {
                    let sha;
                    try {
                      const { data: existing } = await github.rest.repos.getContent({
                        owner: context.repo.owner, repo: context.repo.repo, path: fname
                      });
                      sha = existing.sha;
                    } catch (e) {}

                    await github.rest.repos.createOrUpdateFileContents({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname,
                      message: `DeepSeek Speciale: ${fname}`,
                      content: Buffer.from(fcont).toString('base64'),
                      sha: sha
                    });
                    filesUpdated.push(fname);
                  } catch (err) { console.error(err); }
                }

                while ((match = delRE.exec(aiReply)) !== null) {
                  const fname = match[1].trim();
                  if (['.github/workflows/deepseek.yml'].includes(fname)) continue;
                  try {
                    const { data: existing } = await github.rest.repos.getContent({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname
                    });
                    await github.rest.repos.deleteFile({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname,
                      message: `Speciale Silme: ${fname}`,
                      sha: existing.sha
                    });
                    filesDeleted.push(fname);
                  } catch (e) {}
                }
            }

            // --- RAPOR ---
            let report = `### üèÜ DeepSeek V3.2 SPECIALE Sonucu\n\n`;
            
            // D√º≈ü√ºnce Zincirini G√∂ster (Kanƒ±t)
            if (reasoning) {
                report += `<details><summary>üß† Modelin Beynini Oku (Reasoning Trace)</summary>\n\n\`\`\`text\n${reasoning.substring(0, 3000)}...\n\`\`\`\n</details>\n\n`;
            }

            if (filesUpdated.length > 0) {
               report += `**‚úÖ Olu≈üturulan Dosyalar:**\n`;
               filesUpdated.forEach(f => report += `- \`${f}\`\n`);
            } else if (aiReply && aiReply.length > 0) {
               report += `**‚ö†Ô∏è Dosya Olu≈üturulmadƒ±, Sadece Cevap:**\n${aiReply}\n`;
            } else {
               report += `**‚ùå HATA:** Model √ßok d√º≈ü√ºnd√º ama kod bloƒüu √ºretmedi. L√ºtfen tekrar deneyin.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
