name: DeepSeek V3.2 ULTIMATE AGENT (v10.0)
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  ultimate_brain:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Proje SahasÄ±nÄ± Tarama
        uses: actions/checkout@v4

      - name: DeepSeek ULTIMATE Motorunu Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            // ------------------------------------------------------------------
            // DEEPSEEK V3.2 ULTIMATE EDITION (v10.0 - UNLEASHED)
            // Ã–zellikler: Full Context, Reasoning Trace, Advanced File Ops
            // ------------------------------------------------------------------
            
            console.log("ğŸš€ [ULTIMATE v10] Tam GÃ¼Ã§ Modu BaÅŸlatÄ±lÄ±yor...");
            
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("âš ï¸ API AnahtarÄ± eksik! Secrets ayarlarÄ±nÄ± kontrol et.");

            // --- 1. DERÄ°N ANALÄ°Z (DEEP CONTEXT GATHERING) ---
            // AjanÄ±n projenin her kÃ¶ÅŸesini gÃ¶rmesini saÄŸlayan geliÅŸmiÅŸ tarama
            const criticalFiles = [
              'package.json', 'package-lock.json', // Node
              'requirements.txt', 'setup.py', 'pyproject.toml', // Python
              'composer.json', // PHP
              'go.mod', 'main.go', // Go
              'Cargo.toml', // Rust
              'pom.xml', 'build.gradle', // Java
              'README.md', '.gitignore', 'Dockerfile', 'docker-compose.yml', // DevOps
              'index.html', 'style.css', 'script.js', 'main.py', 'app.py' // YaygÄ±n giriÅŸ noktalarÄ±
            ];
            
            // KullanÄ±cÄ±nÄ±n mesajÄ±nda geÃ§en dosya isimlerini regex ile avla
            const fileMentionRegex = /\b[\w-\/]+\.(js|py|html|css|json|md|yml|yaml|txt|java|c|cpp|go|rs|php|sql|ts|tsx|sh|env)\b/g;
            const mentionedFiles = [...new Set(userMessage.match(fileMentionRegex) || [])];
            
            // Hepsini birleÅŸtir ve tekrar edenleri temizle
            const filesToRead = [...new Set([...criticalFiles, ...mentionedFiles])];
            
            let currentContext = "";
            let foundFilesCount = 0;
            console.log(`ğŸ‘€ [GÃ–Z] Toplam ${filesToRead.length} adet potansiyel dosya taranÄ±yor...`);

            for (const file of filesToRead) {
              try {
                const { data: fileData } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: file
                });
                
                if (fileData.encoding === 'base64' && fileData.type === 'file') {
                  const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
                  // AjanÄ±n kafasÄ±nÄ± karÄ±ÅŸtÄ±rmamak iÃ§in Ã§ok devasa dosyalarÄ± Ã¶zetle
                  let safeContent = content;
                  if (content.length > 12000) {
                     safeContent = content.substring(0, 5000) + `\n...[DOSYA Ã‡OK UZUN, ${content.length - 10000} KARAKTER GÄ°ZLENDÄ°]...\n` + content.substring(content.length - 5000);
                  }
                  currentContext += `\n>>> DOSYA: ${file} <<<\n${safeContent}\n>>> DOSYA SONU <<<\n`;
                  foundFilesCount++;
                }
              } catch (e) {
                // Dosya yoksa pas geÃ§, bu bir hata deÄŸil
              }
            }
            console.log(`âœ… [GÃ–Z] ${foundFilesCount} adet mevcut dosya okunup hafÄ±zaya alÄ±ndÄ±.`);

            // --- 2. ULTIMATE PROMPT (RAPORUN KALBÄ°) ---
            // Bu prompt, modeli "SÄ±radan KodlayÄ±cÄ±" modundan "Otonom Ajan" moduna geÃ§irir.
            const systemPrompt = `
            Sen DeepSeek V3.2 "Speciale" (Ultimate Level) modelisin.
            Sen sadece kod yazmazsÄ±n; projeyi bir CTO (Chief Technology Officer) gibi yÃ¶netirsin.
            
            TEMEL YETENEKLERÄ°N:
            1. **Derin AkÄ±l YÃ¼rÃ¼tme (Deep Reasoning):** Kod yazmadan Ã¶nce <think>...</think> bloÄŸunda karmaÅŸÄ±k mantÄ±k kur.
            2. **Ajan YeteneÄŸi (Agentic Behavior):** Dosya sistemini bir bÃ¼tÃ¼n olarak gÃ¶r. Bir dosyayÄ± deÄŸiÅŸtirirken diÄŸerlerini bozma.
            3. **HatasÄ±z Ãœretim:** KodlarÄ±n "Production-Ready" olmalÄ±. YarÄ±m bÄ±rakma, "burayÄ± sen tamamla" deme.
            
            Ã‡OK Ã–NEMLÄ° - Ã‡IKTI FORMATI:
            DosyalarÄ± oluÅŸturmak veya gÃ¼ncellemek iÃ§in KESÄ°NLÄ°KLE bu formatÄ± kullan:
            
            ---FILENAME: klasor/dosya_adi.uzantÄ±---
            [Kodun TamamÄ± Buraya]
            ---END_OF_FILE---
            
            Dosya silmek iÃ§in:
            ---DELETE: klasor/dosya_adi.uzantÄ±---
            ---END_DELETE---
            `.trim();

            console.log("ğŸ§  [BEYÄ°N] DeepSeek Reasoner (AkÄ±l YÃ¼rÃ¼tme) motoru tetikleniyor...");

            // --- 3. API Ä°STEÄÄ° (TAM GÃœÃ‡) ---
            // 'deepseek-reasoner' endpoint'i kullanÄ±lÄ±yor. Max token limitini zorluyoruz.
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-reasoner", // EN GÃœÃ‡LÃœ MODEL
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: `GÃ–REV: ${userMessage}\n\n=== MEVCUT PROJE DURUMU (CONTEXT) ===\n${currentContext}` }
                ],
                stream: false,
                max_tokens: 8000 // DÃ¼ÅŸÃ¼nmesi iÃ§in maksimum alan
              })
            });

            if (!response.ok) {
               const errText = await response.text();
               console.error("API HATASI:", errText);
               throw new Error(`DeepSeek API HatasÄ±: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            
            // Cevap bileÅŸenlerini al
            const aiReply = data.choices[0].message.content;      
            const reasoning = data.choices[0].message.reasoning_content || "Model bu sefer sessiz dÃ¼ÅŸÃ¼ndÃ¼."; 

            console.log(`âš¡ [CEVAP] Kod UzunluÄŸu: ${aiReply ? aiReply.length : 0}, DÃ¼ÅŸÃ¼nce UzunluÄŸu: ${reasoning.length}`);

            // --- 4. DOSYA Ä°ÅLEME VE YÃ–NETÄ°M (EXECUTION) ---
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            
            let match;
            let filesUpdated = [];
            let filesDeleted = [];
            let errors = [];

            if (aiReply) {
                // Dosya OluÅŸturma/GÃ¼ncelleme
                while ((match = fileRE.exec(aiReply)) !== null) {
                  const fname = match[1].trim();
                  const fcont = match[2].trim();
                  try {
                    let sha;
                    try {
                      const { data: existing } = await github.rest.repos.getContent({
                        owner: context.repo.owner, repo: context.repo.repo, path: fname
                      });
                      sha = existing.sha;
                    } catch (e) {}

                    await github.rest.repos.createOrUpdateFileContents({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname,
                      message: `DeepSeek Ultimate: ${fname}`,
                      content: Buffer.from(fcont).toString('base64'),
                      sha: sha
                    });
                    filesUpdated.push(fname);
                    console.log(`âœ… [BAÅARILI] Dosya iÅŸlendi: ${fname}`);
                  } catch (err) { 
                    console.error(`âŒ [HATA] ${fname} yazÄ±lamadÄ±: ${err.message}`);
                    errors.push(`${fname}: ${err.message}`);
                  }
                }

                // Dosya Silme
                while ((match = delRE.exec(aiReply)) !== null) {
                  const fname = match[1].trim();
                  // Kendini koruma protokolÃ¼
                  if (['.github/workflows/deepseek.yml'].includes(fname)) {
                    console.log(`ğŸ›¡ï¸ [KORUMA] ${fname} silinmeye Ã§alÄ±ÅŸÄ±ldÄ± ama engellendi.`);
                    continue;
                  }
                  
                  try {
                    const { data: existing } = await github.rest.repos.getContent({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname
                    });
                    await github.rest.repos.deleteFile({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname,
                      message: `DeepSeek Ultimate: ${fname} silindi`,
                      sha: existing.sha
                    });
                    filesDeleted.push(fname);
                    console.log(`ğŸ—‘ï¸ [SÄ°LÄ°NDÄ°] ${fname}`);
                  } catch (e) {
                    console.log(`âš ï¸ [UYARI] ${fname} silinemedi (zaten yok olabilir).`);
                  }
                }
            }

            // --- 5. PROFESYONEL RAPORLAMA ---
            let report = `### ğŸ§¬ DeepSeek V3.2 ULTIMATE Raporu\n\n`;
            
            // DÃ¼ÅŸÃ¼nce SÃ¼recini AÃ§Ä±lÄ±r/KapanÄ±r Kutu Yap (Ã‡ok yer kaplamasÄ±n)
            if (reasoning) {
                // Markdown'Ä± bozmamasÄ± iÃ§in reasoning iÃ§indeki ters tÄ±rnaklarÄ± temizle
                const cleanReasoning = reasoning.replace(/`/g, "'"); 
                // Ä°lk 5000 karakteri gÃ¶ster
                const displayReasoning = cleanReasoning.length > 5000 ? cleanReasoning.substring(0, 5000) + "\n... [DevamÄ± Sistem LoglarÄ±nda]" : cleanReasoning;
                
                report += `<details><summary>ğŸ§  <b>AjanÄ±n DÃ¼ÅŸÃ¼nce Zinciri (Reasoning Trace)</b> - TÄ±klayÄ±p Oku</summary>\n\n\`\`\`text\n${displayReasoning}\n\`\`\`\n</details>\n\n`;
            }

            // Ä°ÅŸlem Ã–zeti
            if (filesUpdated.length > 0) {
               report += `#### ğŸ› ï¸ Dosya Ä°ÅŸlemleri:\n`;
               filesUpdated.forEach(f => report += `- âœ… **GÃ¼ncellendi:** \`${f}\`\n`);
            }
            
            if (filesDeleted.length > 0) {
               report += `#### ğŸ—‘ï¸ Temizlik:\n`;
               filesDeleted.forEach(f => report += `- âŒ **Silindi:** \`${f}\`\n`);
            }
            
            // Hata varsa gÃ¶ster
            if (errors.length > 0) {
               report += `#### âš ï¸ KarÅŸÄ±laÅŸÄ±lan Sorunlar:\n`;
               errors.forEach(e => report += `- âŒ ${e}\n`);
            }

            // EÄŸer hiÃ§ dosya iÅŸlemi yoksa, AI'nin mesajÄ±nÄ± gÃ¶ster (Belki sadece soru cevapladÄ±)
            if (filesUpdated.length === 0 && filesDeleted.length === 0) {
               report += `#### ğŸ’¬ Ajan MesajÄ±:\n${aiReply || "Hata: Ajan boÅŸ cevap dÃ¶ndÃ¼."}\n`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
