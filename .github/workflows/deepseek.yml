name: DeepSeek V3.2 GRANDMASTER (FIXED)
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write

jobs:
  grandmaster_agent_fix:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]' && (github.event_name == 'issues' || github.event_name == 'issue_comment')
    steps:
      - name: Proje SahasÄ±nÄ± Tarama
        uses: actions/checkout@v4

      - name: DeepSeek Grandmaster Motorunu Ã‡alÄ±ÅŸtÄ±r
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        with:
          script: |
            // ------------------------------------------------------------------
            // DEEPSEEK V3.2 SPECIALE: GRANDMASTER EDITION (v9.1 - CLEAN)
            // Hata DÃ¼zeltmesi: 'cite_start' referans hatasÄ± giderildi.
            // ------------------------------------------------------------------
            
            console.log("ðŸš€ [GRANDMASTER v9.1] Sistem baÅŸlatÄ±lÄ±yor...");
            
            const userMessage = context.payload.comment ? context.payload.comment.body : context.payload.issue.body;
            const apiKey = process.env.API_KEY ? process.env.API_KEY.trim() : "";
            
            if (!apiKey) throw new Error("API AnahtarÄ± eksik! LÃ¼tfen Secrets ayarlarÄ±nÄ± kontrol edin.");

            // --- 1. DOSYA VE CONTEXT ANALÄ°ZÄ° ---
            // Kritik dosyalarÄ± ve kullanÄ±cÄ±nÄ±n bahsettiÄŸi dosyalarÄ± okuyoruz.
            const criticalFiles = [
              'package.json', 'requirements.txt', 'README.md', 
              'docker-compose.yml', '.gitignore', 'pom.xml', 'go.mod'
            ];
            
            // Regex: Mesajda geÃ§en dosya isimlerini yakalar
            const fileMentionRegex = /\b[\w-\/]+\.(js|py|html|css|json|md|yml|yaml|txt|java|c|cpp|go|rs|php|sql|ts|tsx)\b/g;
            const mentionedFiles = [...new Set(userMessage.match(fileMentionRegex) || [])];
            
            // Hepsini birleÅŸtir
            const filesToRead = [...new Set([...criticalFiles, ...mentionedFiles])];
            
            let currentContext = "";
            console.log(`ðŸ‘€ [GÃ–Z] ${filesToRead.length} dosya taranÄ±yor...`);

            for (const file of filesToRead) {
              try {
                const { data: fileData } = await github.rest.repos.getContent({
                  owner: context.repo.owner, repo: context.repo.repo, path: file
                });
                
                if (fileData.encoding === 'base64' && fileData.type === 'file') {
                  const content = Buffer.from(fileData.content, 'base64').toString('utf-8');
                  // Ã‡ok uzun dosyalarÄ± kÄ±rp (Token limiti iÃ§in)
                  let safeContent = content;
                  if (content.length > 8000) {
                     safeContent = content.substring(0, 4000) + "\n...[KISALTILDI]...\n" + content.substring(content.length - 2000);
                  }
                  currentContext += `\n>>> DOSYA: ${file} <<<\n${safeContent}\n---DOSYA SONU---\n`;
                  console.log(`ðŸ“– Okundu: ${file}`);
                }
              } catch (e) {
                // Dosya yoksa hata verme, devam et
              }
            }

            // --- 2. SÄ°STEM PROMPTU (RAPORDAN ALINAN STRATEJÄ°) ---
            const systemPrompt = `
            Sen DeepSeek V3.2 Speciale (Grandmaster Level) modelisin.
            GÃ¶revin: KullanÄ±cÄ±nÄ±n isteÄŸini profesyonelce kodlamak ve yÃ¶netmek.
            
            KURALLAR:
            1. **Reasoning (DÃ¼ÅŸÃ¼nme):** Kodlamadan Ã¶nce <think> bloÄŸunda plan yap.
            2. **Ajan YeteneÄŸi:** Proje yapÄ±sÄ±nÄ± koru, baÄŸÄ±mlÄ±lÄ±klarÄ± yÃ¶net.
            3. **Kesin Format:** Dosya iÅŸlemleri iÃ§in aÅŸaÄŸÄ±daki formatÄ± kullanmak ZORUNDASIN.
            
            DOSYA OLUÅžTURMA FORMATI:
            ---FILENAME: yol/dosya_adi.uzantÄ±---
            [Kodun TamamÄ± Buraya]
            ---END_OF_FILE---
            
            DOSYA SÄ°LME FORMATI:
            ---DELETE: yol/dosya_adi.uzantÄ±---
            ---END_DELETE---
            `.trim();

            console.log("ðŸ§  [BEYÄ°N] DeepSeek API'ye baÄŸlanÄ±lÄ±yor...");

            // --- 3. API Ä°STEÄžÄ° (deepseek-reasoner) ---
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`, 
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-reasoner", // Speciale Modeli
                messages: [
                  { role: "system", content: systemPrompt },
                  { role: "user", content: `GÃ–REV: ${userMessage}\n\n=== BAÄžLAM ===\n${currentContext}` }
                ],
                stream: false,
                max_tokens: 8000
              })
            });

            if (!response.ok) {
               const errText = await response.text();
               throw new Error(`DeepSeek API HatasÄ±: ${errText}`);
            }

            const data = await response.json();
            const aiReply = data.choices[0].message.content;      
            const reasoning = data.choices[0].message.reasoning_content || ""; 

            console.log(`âš¡ Cevap alÄ±ndÄ±. Kod uzunluÄŸu: ${aiReply ? aiReply.length : 0}`);

            // --- 4. DOSYA Ä°ÅžLEME ---
            const fileRE = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            const delRE = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
            
            let match;
            let filesUpdated = [];
            let filesDeleted = [];

            // Cevap boÅŸ deÄŸilse iÅŸle
            if (aiReply) {
                // Dosya Yazma
                while ((match = fileRE.exec(aiReply)) !== null) {
                  const fname = match[1].trim();
                  const fcont = match[2].trim();
                  try {
                    let sha;
                    try {
                      const { data: existing } = await github.rest.repos.getContent({
                        owner: context.repo.owner, repo: context.repo.repo, path: fname
                      });
                      sha = existing.sha;
                    } catch (e) {}

                    await github.rest.repos.createOrUpdateFileContents({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname,
                      message: `Grandmaster v9.1: ${fname}`,
                      content: Buffer.from(fcont).toString('base64'),
                      sha: sha
                    });
                    filesUpdated.push(fname);
                    console.log(`âœ… OluÅŸturuldu: ${fname}`);
                  } catch (err) { console.error(`Hata (${fname}): ${err.message}`); }
                }

                // Dosya Silme
                while ((match = delRE.exec(aiReply)) !== null) {
                  const fname = match[1].trim();
                  if (['.github/workflows/deepseek.yml'].includes(fname)) continue;
                  try {
                    const { data: existing } = await github.rest.repos.getContent({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname
                    });
                    await github.rest.repos.deleteFile({
                      owner: context.repo.owner, repo: context.repo.repo, path: fname,
                      message: `Silindi: ${fname}`,
                      sha: existing.sha
                    });
                    filesDeleted.push(fname);
                  } catch (e) {}
                }
            }

            // --- 5. RAPORLAMA ---
            let report = `### ðŸ‘‘ DeepSeek Grandmaster (v9.1) Raporu\n\n`;
            
            if (reasoning) {
                // DÃ¼ÅŸÃ¼nce zincirini rapora ekle (Karakter limiti kontrolÃ¼ ile)
                const safeReasoning = reasoning.length > 3000 ? reasoning.substring(0, 3000) + "\n... (DevamÄ± gizlendi)" : reasoning;
                report += `<details><summary>ðŸ§  <b>DÃ¼ÅŸÃ¼nce SÃ¼reci (Reasoning Trace)</b></summary>\n\n\`\`\`text\n${safeReasoning}\n\`\`\`\n</details>\n\n`;
            }

            if (filesUpdated.length > 0) {
               report += `**âœ… Ä°ÅŸlenen Dosyalar:**\n`;
               filesUpdated.forEach(f => report += `- \`${f}\`\n`);
            }
            
            if (filesDeleted.length > 0) {
               report += `**ðŸ—‘ï¸ Silinen Dosyalar:**\n`;
               filesDeleted.forEach(f => report += `- \`${f}\`\n`);
            }
            
            if (filesUpdated.length === 0 && filesDeleted.length === 0) {
               report += `**ðŸ’¬ Cevap:**\n${aiReply || "Hata: BoÅŸ cevap dÃ¶ndÃ¼."}`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner, repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
